WorkerTracking App - Bug Fix TODO List
========================================

Generated: 2026-01-27
Source: Code reviews from 3 junior developers (validated)
Status: All bugs below have been validated against the codebase


CRITICAL BUGS - FIX IMMEDIATELY
================================

1. Circular Reference Validation Missing
   Location: Worker.kt:12-17, WorkerRepository.kt:283-298
   Problem: Worker entity has self-referencing foreign key (referenceId) with no
            validation to prevent circular references (A→B→A)
   Impact: Infinite loops in payment calculations, app crashes
   Fix Required:
   - Add validation function to check reference chains before saving
   - Add database constraint or trigger to prevent cycles
   - Add cycle detection in WorkerRepository.getWorkerById() reference lookups

HIGH PRIORITY BUGS
==================


MAJOR BUGS
==========



MEDIUM PRIORITY BUGS
====================

10. Payment Dialog Doesn't Validate Against Total
    Location: WorkerDetailScreen.kt:646-648
    Problem: Partial payment has no validation that amountPaid + currentAmountPaid <= totalDue
    Impact: Users can pay more than owed, causing negative balances
    Fix Required:
    - Add validation before saving payment
    - Show error if payment exceeds remaining balance
    - Show remaining balance in dialog

11. Missing Database Indices on Foreign Keys
    Location: All entity files
    Problem: No indices defined on foreign key columns (workerId, shiftId, eventId, etc.)
    Impact: Slow queries when joining tables, especially with large datasets
    Fix Required:
    - Add @Index annotations to all entities
    - Example: @Entity(indices = [Index("workerId"), Index("eventId")])
    - Create migration to add indices

12. Locale Hardcoded to Hebrew
    Location: Multiple files using Locale("he", "IL")
    Problem: Currency formatting hardcoded instead of using device locale
    Impact: Users in other countries see Hebrew formatting
    Fix Required:
    - Use Locale.getDefault() instead of hardcoded Locale("he", "IL")
    - OR: Add locale setting to user preferences


LOW PRIORITY / MINOR BUGS
==========================

13. Inconsistent Error Handling
    Location: All ViewModels
    Problem: Empty catch blocks silently swallow errors
    Impact: Users have no feedback when operations fail
    Fix Required:
    - Add error state to ViewModels
    - Show error messages to users

14. Worker Detail Project History Hardcoded Empty
    Location: WorkerDetailViewModel.kt:117
    Problem: Projects hardcoded to emptyList() with TODO comment
    Impact: Worker detail screen never shows project history
    Fix Required:
    - Implement actual project history query
    - Remove TODO and empty list

15. Navigation Clears Entire Backstack
    Location: MainActivity.kt:135-142
    Problem: Dashboard navigation uses popUpTo(0) { inclusive = true }
    Impact: User can't navigate back after visiting dashboard
    Note: May be intentional design, verify with product requirements

16. ShiftWorker Payment Status Not Granular
    Location: ShiftWorker entity (inferred)
    Problem: ShiftWorker only has isPaid boolean, unlike EventWorker which has amountPaid,
             tipAmount, etc.
    Impact: Shifts don't support partial payments or tips
    Fix Required:
    - Add amountPaid, tipAmount fields to ShiftWorker
    - Add referenceAmountPaid, referenceTipAmount fields
    - Update UI to support partial shift payments

17. Manual Event Bus Instead of Reactive Data
    Location: MoneyOwedViewModel.kt calling appContainer.triggerDashboardRefresh()
    Problem: ViewModels manually trigger refreshes instead of using Room Flows
    Impact: Tight coupling to DI container, unnecessary complexity
    Fix Required:
    - Use Flow<List<Data>> from Room to auto-update UI
    - Remove manual refresh triggers


POTENTIAL ISSUES - VERIFY
==========================

18. Date Type Conversion
    Location: WorkerRepository.kt:217, 236
    Question: Is shiftDate stored as Long (millis) or Date object?
    Action: Verify data type and ensure Date(shift.shiftDate) is correct

19. Worker Deletion Cascade
    Location: Worker.kt:16
    Question: Should historical ShiftWorker/EventWorker records be preserved when worker deleted?
    Action: Verify intended behavior with product owner

20. Reference Worker Commission on Fixed Amount
    Location: WorkerRepository.kt:265, EventDetailScreen.kt:299-301
    Question: Should reference workers get hourly commission when referred worker got fixed payment?
    Action: Clarify business logic with product owner


ARCHITECTURE IMPROVEMENTS
==========================

21. Split EventWorker Table
    Recommendation: Separate worker payments from reference/manager commissions
    Benefit: Clearer data model
    Tables: EventWorker (worker pay) + EventCommission (manager commission)

22. Normalize Payment Calculation Logic
    Recommendation: Create single source of truth for payment math
    Benefit: Consistent calculations across all ViewModels
    Implementation: Create PaymentCalculator class with all formulas


========================================
PRIORITY ORDER
========================================

1. Fix Circular Reference Validation (Bug #1) - Prevent infinite loops [COMPLETED]
2. Fix Flow Memory Leaks (Bug #4) - Memory stability [COMPLETED]
3. Fix Dashboard Date Filter Ignores Project Income (Bug #8) - Data accuracy [COMPLETED]
4. Remaining Major/Medium bugs as time permits


========================================
TESTING GAPS
========================================

- No unit tests exist for payment calculations
- No tests for date filtering logic
- No tests for time input validation
- No tests for circular reference detection

Add comprehensive test coverage for all payment math before making fixes.
